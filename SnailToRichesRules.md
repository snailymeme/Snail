# Правила и структура проекта "Улитка к богатству" (Snail to Riches)

## Общее описание проекта
"Улитка к богатству" - это HTML5-игра в формате Telegram WebApp. Игрок делает ставку на цвет улитки, которая соревнуется с другими улитками, двигаясь по лабиринту к финишу. Характеристики улиток (скорость, суперспособности) случайно распределяются между цветами перед каждой гонкой, так что игрок не знает, какая именно улитка ему достанется. Если улитка игрока занимает призовое место, он получает выигрыш. Игра интегрируется с Solana-кошельком через Phantom для ставок и выплат.

**Цель**: создать MVP (минимально жизнеспособный продукт), который:
- Работает внутри Telegram WebApp.
- Позволяет делать ставки и получать выигрыш через Solana-кошелек.
- Имеет базовый игровой интерфейс и логику.

**Расширенная версия (турниры)**:
- Пул ставок распределяется: 1-е место - 70% пула, 2-е - 50% ставки, 3-е - 25% ставки, 4-5-е - проигрыш.

---

## Структура проекта

```
modules/
├── game/                        # Основной игровой модуль
│   ├── Snails/                 # Логика улиток (движение, поведение)
│   │   ├── RacerSlug/         # Подмодуль для racerSlug
│   │   │   ├── characteristics.js  # Характеристики (скорость, цвет и т.д.)
│   │   │   ├── superAbility.js     # Суперспособность (резкие ускорения)
│   │   │   └── patch.js            # Патч поведения (алгоритм движения)
│   │   ├── ExplorerSlug/      # Подмодуль для explorerSlug
│   │   │   ├── characteristics.js  # Характеристики
│   │   │   ├── superAbility.js     # Суперспособность (обход препятствий)
│   │   │   └── patch.js            # Патч поведения
│   │   ├── SnakeSlug/         # Подмодуль для snakeSlug
│   │   │   ├── characteristics.js  # Характеристики
│   │   │   ├── superAbility.js     # Суперспособность (извивающийся маршрут)
│   │   │   └── patch.js            # Патч поведения
│   │   ├── StubbornSlug/      # Подмодуль для stubbornSlug
│   │   │   ├── characteristics.js  # Характеристики
│   │   │   ├── superAbility.js     # Суперспособность (застревание с рывком)
│   │   │   └── patch.js            # Патч поведения
│   │   ├── DefaultSlug/       # Подмодуль для defaultSlug
│   │   │   ├── characteristics.js  # Характеристики
│   │   │   ├── superAbility.js     # Суперспособность (сбалансированное движение)
│   │   │   └── patch.js            # Патч поведения
│   │   └── Core/              # Общая логика для всех улиток
│   │       ├── baseSnail.js   # Базовый класс Snail
│   │       ├── patchLoader.js # Загрузчик патчей для улиток
│   │       ├── randomizer.js  # Рандомизация характеристик по цветам
│   │       └── SnailFactory.js # Фабрика для создания улиток с случайными характеристиками
│   ├── Maze/                  # Генерация и отрисовка лабиринта
│   │   ├── Generator/        # Генерация лабиринта
│   │   ├── Styles/          # Стили и темы лабиринта
│   │   ├── Obstacles/       # Препятствия в лабиринте (ловушки, ускорители)
│   │   └── Renderer/        # Отрисовка лабиринта на Canvas
│   ├── Race/                # Логика гонки (старт, финиш, результаты)
│   ├── Betting/            # Логика ставок (выбор цвета, расчет)
│   │   ├── Winnings/       # Логика выигрышей
│   │   ├── Placement/      # Определение места (1-е, 2-е, 3-е и т.д.)
│   │   ├── Payout/        # Расчет и распределение выигрышей
│   │   └── Notifier/      # Уведомления о результатах
│   └── blockchain/         # Модуль для работы с блокчейном (Solana)
│       ├── Wallet/        # Подключение кошелька (Phantom)
│       └── Transactions/  # Обработка транзакций (ставки, выплаты)
│           └── Validation/ # Проверка транзакций и баланса
├── common/                 # Общие утилиты и сервисы
│   ├── db/               # Утилиты для базы данных (если нужно хранить данные)
│   ├── api/              # Клиенты для работы с API (например, Telegram, Solana)
│   └── utils/            # Общие утилитарные функции
│       └── models/       # Общие модели данных (например, Snail, Race)
└── bot/                  # Основные файлы бота
    ├── handlers/        # Обработчики команд (например, /start)
    ├── keyboards/       # Макеты клавиатур (выбор цвета, ставка)
    └── middlewares/     # Промежуточные слои (middleware)
        └── filters/     # Фильтры сообщений
```

---

## Правила разработки

### Core Development Principles
1. **Write Simple Code**:  
   При написании кода в любом файле (например, `game/Snails/RacerSlug/patch.js` или `blockchain/Transactions/transactions.js`) минимизируй количество строк. Например, вместо сложных циклов для движения улитки используй простые функции, такие как `moveSnail(distance)`, и избегай избыточных условий.

2. **Preserve Existing Functionality**:  
   После добавления новой функции (например, нового поведения улитки в `game/Snails/RacerSlug/patch.js`) убедись, что существующие функции, такие как генерация лабиринта в `game/Maze/Generator/mazeGenerator.js` и обработка ставок в `game/Betting/betting.js`, продолжают работать. Проверь это, запустив гонку в Telegram WebApp и убедившись, что нет ошибок в консоли.

3. **Optimize for Readability**:  
   При написании кода в любом файле (например, `game/Race/race.js`) используй понятные имена переменных и функций, такие как `startRace()` или `calculateWinner()`, вместо `sr()` или `cw()`. Добавляй пробелы и переносы строк для читаемости, например, отделяй блоки логики пустыми строками.

4. **DRY Principle**:  
   Если ты пишешь код, который повторяется (например, логика движения улитки в `game/Snails/RacerSlug/patch.js` и `game/Race/race.js`), вынеси его в общую функцию в `common/utils/movement.js`, например, `moveEntity(entity, distance)`. Убедись, что эта функция используется во всех нужных местах, и проверь, что она работает корректно, запустив гонку.

5. **Modular Snail Logic**:  
   Каждая улитка должна быть реализована в своём подмодуле в `game/Snails/`, например, `game/Snails/RacerSlug/`. Характеристики улитки (скорость, цвет) храни в `characteristics.js`, суперспособность - в `superAbility.js`, а патч поведения - в `patch.js`. Убедись, что улитка наследуется от `BaseSnail` из `game/Snails/Core/baseSnail.js`, и её патч загружается через `game/Snails/Core/patchLoader.js`. Проверь, что улитка двигается корректно, запустив тестовую гонку.

6. **Modular Maze Logic**:  
   Разделяй логику лабиринта на подмодули в `game/Maze/`. Например, генерация лабиринта должна быть в `game/Maze/Generator/mazeGenerator.js`, стили - в `game/Maze/Styles/mazeStyles.js`, а отрисовка - в `game/Maze/Renderer/mazeRenderer.js`. Убедись, что каждый подмодуль выполняет только свою задачу, и проверь, что подмодули взаимодействуют корректно, запустив гонку с несколькими улитками.

7. **Randomized Snail Characteristics**:  
   Перед началом гонки в `game/Snails/SnailFactory.js` используй `randomizeSnails` из `game/Snails/Core/randomizer.js`, чтобы случайно распределить характеристики улиток по цветам. Игрок выбирает цвет, а улитка создаётся с случайными характеристиками через `createSnail(color)`. Убедись, что цвет улитки соответствует выбору игрока, но характеристики (например, скорость, суперспособность) берутся из случайного типа улитки. Проверь, что рандомизация работает, запустив гонку и убедившись, что улитки имеют разные характеристики при одном цвете в разных гонках.

---

### Project Structure
1. **Respect Module Boundaries**:  
   Каждый подмодуль в `game/Snails/` и `game/Maze/` должен быть независимым. Например, `game/Snails/RacerSlug/patch.js` использует характеристики из `game/Snails/RacerSlug/characteristics.js` и суперспособность из `game/Snails/RacerSlug/superAbility.js`, но не обращается напрямую к другим улиткам. Для общей логики используй `game/Snails/Core/`. Аналогично, `game/Maze/Generator/mazeGenerator.js` генерирует лабиринт и возвращает его как массив, `game/Maze/Styles/mazeStyles.js` предоставляет стили, а `game/Maze/Renderer/mazeRenderer.js` использует эти данные для отрисовки на Canvas. Проверь, что подмодули взаимодействуют корректно, запустив гонку с несколькими улитками.

2. **Use Shared Components**:  
   Если тебе нужно использовать общую логику (например, форматирование сообщений для Telegram), помести её в `common/utils/formatter.js`, например, функцию `formatMessage(text)`. Используй эту функцию в `bot/handlers/start.js` и `game/Betting/betting.js`, чтобы отправлять сообщения. Убедись, что форматирование работает, отправив тестовое сообщение через бота.

---

### JavaScript Standards
1. **JavaScript Version**:  
   Используй современные возможности JavaScript (ES2020+), такие как `async/await` для работы с Solana в `blockchain/Transactions/transactions.js` или опциональную цепочку (`?.`) для обработки данных в `game/Snails/SnailFactory.js`. Убедись, что код работает в современном браузере, протестировав его в Chrome.

2. **Code Style**:  
   Следуй стандартам стиля кода: используй 2 пробела для отступов, максимальная длина строки - 80 символов, имена функций в camelCase (например, `moveSnail`), имена констант в UPPER_CASE (например, `MAX_SPEED`). В начале каждого файла (например, `game/Maze/mazeGenerator.js`) сортируй импорты: сначала встроенные модули (`import { useEffect } from 'react'`), затем сторонние, затем локальные.

3. **Type Annotations**:  
   Добавляй аннотации типов с помощью JSDoc для всех функций в файлах, таких как `game/Snails/RacerSlug/patch.js`. Пример:  
   ```javascript
   /**
    * Перемещает улитку на заданное расстояние.
    * @param {number} distance - Расстояние для перемещения.
    * @returns {void}
    */
   function moveSnail(distance) { ... }
   ```
   Проверь, что аннотации корректны, запустив линтер (например, ESLint).

4. **Consistent Snail Characteristics**:  
   В `game/Snails/*/characteristics.js` (например, `game/Snails/RacerSlug/characteristics.js`) храни характеристики улитки в формате объекта с обязательными полями: `name`, `color`, `baseSpeed`, `winChance`. Пример:  
   ```javascript
   module.exports = {
     name: 'RacerSlug',
     color: 'red',
     baseSpeed: 2,
     winChance: 0.3,
   };
   ```
   Убедись, что характеристики используются в `BaseSnail` при создании улитки, и проверь, что они применяются корректно, запустив гонку.

5. **Consistent Maze Styles**:  
   В `game/Maze/Styles/mazeStyles.js` создавай стили лабиринта как объект с чёткими ключами, например:  
   ```javascript
   const mazeThemes = {
     swamp: { wallColor: 'darkgreen', pathColor: 'lightgreen', obstacleColor: 'brown' },
     forest: { wallColor: 'darkbrown', pathColor: 'green', obstacleColor: 'gray' },
   };
   module.exports = mazeThemes;
   ```
   Используй эти стили в `game/Maze/Renderer/mazeRenderer.js` для отрисовки. Проверь, что тема применяется корректно, выбрав одну из тем и запустив гонку.

---

### Code Quality
1. **Keep Files Small**:  
   Держи файлы, такие как `game/Snails/RacerSlug/patch.js` или `blockchain/Wallet/wallet.js`, меньше 300 строк. Если файл становится больше, разбей его на несколько, например, вынеси логику поведения улитки в `game/Snails/RacerSlug/behavior.js`. Убедись, что после разделения всё работает, запустив гонку. 